name: Build and Release

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # Lint and test
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run ESLint
        run: pnpm run lint

      - name: Run TypeScript checks
        run: pnpm run typecheck

      - name: Check formatting
        run: pnpm run format:check

  # Build Service (Node.js)
  build-service:
    name: Build Service
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build packages
        run: pnpm run build --filter @openfm/core --filter @openfm/ui

      - name: Build service
        run: pnpm run build --filter @openfm/service

      - name: Upload service artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-build
          path: apps/service/dist

  # Build Desktop App (Tauri)
  build-desktop:
    name: Build Desktop - ${{ matrix.platform }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            os: windows
            target: x86_64-pc-windows-msvc
          - platform: 'macos-latest'
            os: macos
            target: x86_64-apple-darwin
          - platform: 'macos-latest'
            os: macos-arm
            target: aarch64-apple-darwin
          - platform: 'ubuntu-latest'
            os: linux
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './apps/desktop/src-tauri -> target'

      - name: Install Linux dependencies
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf libxdo-dev libssl-dev

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build desktop app
        run: pnpm --filter @openfm/desktop exec tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload Windows artifacts
        if: matrix.os == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows
          path: |
            apps/desktop/src-tauri/target/release/bundle/msi/*.msi
            apps/desktop/src-tauri/target/release/bundle/nsis/*.exe

      - name: Upload macOS artifacts
        if: matrix.os == 'macos' || matrix.os == 'macos-arm'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.os }}
          path: |
            apps/desktop/src-tauri/target/release/bundle/dmg/*.dmg
            apps/desktop/src-tauri/target/release/bundle/macos/*.app

      - name: Upload Linux artifacts
        if: matrix.os == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux
          path: |
            apps/desktop/src-tauri/target/release/bundle/deb/*.deb
            apps/desktop/src-tauri/target/release/bundle/appimage/*.AppImage

  # Build OBS Plugin
  build-obs-plugin:
    name: Build OBS Plugin - ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            cmake_generator: 'Visual Studio 17 2022'
            obs_version: '31.0.0'
          - os: macos-latest
            platform: macos
            cmake_generator: 'Unix Makefiles'
            obs_version: '31.0.0'

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          modules: 'qtwebengine qtwebchannel qtpositioning qtwebview'
          cache: true

      - name: Install CMake
        uses: lukka/get-cmake@latest

      - name: Download OBS Studio (Windows)
        if: matrix.platform == 'windows'
        run: |
          $obsVersion = "${{ matrix.obs_version }}"
          $url = "https://github.com/obsproject/obs-studio/releases/download/$obsVersion/OBS-Studio-$obsVersion-Full-x64.zip"
          Invoke-WebRequest -Uri $url -OutFile "obs-studio.zip"
          Expand-Archive -Path "obs-studio.zip" -DestinationPath "obs-studio"
        shell: pwsh

      - name: Download OBS Studio (macOS)
        if: matrix.platform == 'macos'
        run: |
          OBS_VERSION="${{ matrix.obs_version }}"
          curl -L "https://github.com/obsproject/obs-studio/releases/download/${OBS_VERSION}/obs-studio-${OBS_VERSION}-macos-x86_64.dmg" -o obs-studio.dmg
          hdiutil attach obs-studio.dmg
          mkdir -p obs-studio
          cp -r "/Volumes/OBS-${OBS_VERSION}/OBS.app" obs-studio/

      - name: Configure CMake (Windows)
        if: matrix.platform == 'windows'
        working-directory: apps/obs-plugin
        run: |
          cmake -B build -G "${{ matrix.cmake_generator }}" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DOBS_DIR="${{ github.workspace }}/obs-studio" `
            -DQt6_DIR="${{ env.Qt6_DIR }}"
        shell: pwsh

      - name: Configure CMake (macOS)
        if: matrix.platform == 'macos'
        working-directory: apps/obs-plugin
        run: |
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DOBS_DIR="${{ github.workspace }}/obs-studio/OBS.app/Contents" \
            -DQt6_DIR="${{ env.Qt6_DIR }}"

      - name: Build plugin
        working-directory: apps/obs-plugin
        run: cmake --build build --config Release

      - name: Package plugin (Windows)
        if: matrix.platform == 'windows'
        working-directory: apps/obs-plugin
        run: |
          mkdir -p package/obs-plugins/64bit
          mkdir -p package/data/obs-plugins/openfm
          Copy-Item build/Release/openfm.dll package/obs-plugins/64bit/
          Copy-Item -Recurse data/* package/data/obs-plugins/openfm/
          Compress-Archive -Path package/* -DestinationPath openfm-obs-windows.zip
        shell: pwsh

      - name: Package plugin (macOS)
        if: matrix.platform == 'macos'
        working-directory: apps/obs-plugin
        run: |
          mkdir -p package/obs-plugins
          mkdir -p package/data/obs-plugins/openfm
          cp -r build/openfm.so package/obs-plugins/
          cp -r data/* package/data/obs-plugins/openfm/
          cd package && zip -r ../openfm-obs-macos.zip *

      - name: Upload OBS plugin
        uses: actions/upload-artifact@v4
        with:
          name: obs-plugin-${{ matrix.platform }}
          path: apps/obs-plugin/openfm-obs-*.zip

  # Create Release
  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-service, build-desktop, build-obs-plugin]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
