name: Build OpenFM

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

jobs:
  lint-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[auto]')"
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Lint
        run: pnpm run lint
      
      - name: Type check
        run: pnpm run typecheck
      
      - name: Test
        run: pnpm run test

  build-service:
    name: Build Service
    runs-on: ubuntu-latest
    needs: lint-test
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build packages
        run: pnpm run build
      
      - name: Upload service artifacts
        uses: actions/upload-artifact@v4
        with:
          name: service
          path: apps/service/dist

  build-desktop-windows:
    name: Build Desktop (Windows)
    runs-on: windows-latest
    needs: lint-test
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build desktop app
        run: |
          cd apps/desktop
          pnpm build
      
      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows
          path: apps/desktop/src-tauri/target/release/bundle

  build-desktop-macos:
    name: Build Desktop (macOS)
    runs-on: macos-latest
    needs: lint-test
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build desktop app
        run: |
          cd apps/desktop
          pnpm build
      
      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos
          path: apps/desktop/src-tauri/target/release/bundle

  build-obs-plugin-windows:
    name: Build OBS Plugin (Windows)
    runs-on: windows-latest
    needs: lint-test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.0'
          arch: 'win64_msvc2019_64'
      
      - name: Configure CMake
        run: |
          cd apps/obs-plugin
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
      
      - name: Build plugin
        run: |
          cd apps/obs-plugin/build
          cmake --build . --config Release
      
      - name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: obs-plugin-windows
          path: apps/obs-plugin/build/Release

  build-obs-plugin-macos:
    name: Build OBS Plugin (macOS)
    runs-on: macos-latest
    needs: lint-test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        run: brew install qt@6
      
      - name: Configure CMake
        run: |
          cd apps/obs-plugin
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
      
      - name: Build plugin
        run: |
          cd apps/obs-plugin/build
          cmake --build . --config Release
      
      - name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: obs-plugin-macos
          path: apps/obs-plugin/build

  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [build-service, build-desktop-windows, build-desktop-macos, build-obs-plugin-windows, build-obs-plugin-macos]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create installer packages
        run: |
          # TODO: Run Inno Setup for Windows
          # TODO: Run pkgbuild for macOS
          echo "Creating installer packages..."
      
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            installers/OpenFM-Setup-x64.exe
            installers/OpenFM-macOS.pkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

